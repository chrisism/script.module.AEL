trigger:
- main
- release/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  isMaster: or(${{eq(variables['Build.SourceBranch'], 'refs/heads/master')}},${{eq(variables['Build.SourceBranch'], 'refs/heads/main')}})
  isReleaseCandidate: ${{startsWith(variables['Build.SourceBranch'], 'refs/heads/release/')}}
  isHotfix: ${{startsWith(variables['Build.SourceBranch'], 'refs/heads/hotfix/')}}
  isDev: ${{eq(variables['Build.SourceBranch'], 'refs/heads/dev')}}
  workingDirectory: '$(Build.SourcesDirectory)'

stages:
- stage: Build
  displayName: Build stage
  jobs:
    - job: build
      displayName: build
        
      steps:
      - task: gitversion/setup@0
        displayName: 'Install GitTools'
        inputs:
          versionSpec: '5.3.x'

      - task: gitversion/execute@0
        displayName: 'Executing gitversion'

      - script: |
            echo '##vso[task.setvariable variable=packageVersion]$(GitVersion.NuGetVersionV2)
            echo '##vso[task.setvariable variable=projectVersion]$(GitVersion.Major).$(GitVersion.Minor).$(GitVersion.Patch)
        displayName: 'Setting version variables'
        condition: not(or(${{variables.isMaster}}, ${{variables.isDev}}, ${{variables.isReleaseCandidate}}, ${{variables.isHotfix}}))
        
      - script: |
            echo '##vso[task.setvariable variable=packageVersion]$(GitVersion.Major).$(GitVersion.Minor).$(GitVersion.Patch)
            echo '##vso[task.setvariable variable=projectVersion]$(GitVersion.Major).$(GitVersion.Minor).$(GitVersion.Patch)
        displayName: 'Setting version variables'
        condition: or(${{variables.isMaster}}, ${{variables.isDev}}, ${{variables.isReleaseCandidate}}, ${{variables.isHotfix}})

      - task: RegExMatchReplace@2
        displayName: 'Set addon version'
        inputs:
          PathToFile: 'addon.xml'
          RegEx: 'version="\d+\.\d+\.\d+.*" provider'
          ValueToReplace: 'version="$(packageVersion)" provider'
          
      - task: CopyFiles@2
        displayName: 'Copy addon files for package'
        inputs:
          SourceFolder: ''
          Contents: |
              *.md
              *.xml
              lib/**/*.*
              media/**/*.*
          TargetFolder: '$(build.artifactstagingdirectory)/script.module.akl/'
          CleanTargetFolder: true
          flattenFolders: false

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: '$(build.artifactstagingdirectory)/script.module.akl'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(build.artifactstagingdirectory)/package/script.module.akl-$(packageVersion).zip'
          replaceExistingArchive: true
 
      - task: CopyFiles@2
        displayName: 'Copy addon files for repository'
        inputs:
          SourceFolder: '$(build.artifactstagingdirectory)/script.module.akl/'
          Contents: |
              addon.xml
              media/**/*.*
          TargetFolder: '$(build.artifactstagingdirectory)/package/'
          CleanTargetFolder: false
          flattenFolders: false

      - script: md5sum script.module.akl-$(packageVersion).zip > script.module.akl-$(packageVersion).zip.md5
        workingDirectory: $(build.artifactstagingdirectory)/package/
        displayName: 'Creating md5 file'

      - task: PublishBuildArtifacts@1
        displayName: 'Publishing application as artifact'
        inputs:
          PathtoPublish: '$(build.artifactstagingdirectory)/package/'
          ArtifactName: 'script.module.akl'
          publishLocation: 'Container'
     
- stage: DeployProd
  displayName: Deployment on Production
  condition: eq(${{variables.isMaster}}, true)
  jobs:
    - deployment: Production
      environment: 
        name: Production

      variables:
        - group: repository.production.variables

      strategy:     
        runOnce:
          deploy:
            steps:
            - download: current
              displayName: 'Downloading Application artifact'
              artifact: 'script.module.akl'

            - script: |
                git clone https://github.com/chrisism/repository.chrisism.git
              workingDirectory: $(Pipeline.Workspace)/
              displayName: 'Clone git repository'

            - script: |
                git config user.email $(git_emailAddress)
                git config user.name $(git_userName)
              workingDirectory: $(Pipeline.Workspace)/repository.chrisism/
              displayName: 'Configure git settings'

            - task: CopyFiles@2
              displayName: 'Copy addon into git repository'
              inputs:
                SourceFolder: '$(Pipeline.Workspace)/script.module.akl'
                Contents: '**/*.*'
                TargetFolder: '$(Pipeline.Workspace)/repository.chrisism/script.module.akl'
                CleanTargetFolder: false
                flattenFolders: false

            - task: XmlMerge@1
              displayName: 'Merge addon xml files'
              inputs:
                remote1: 'Local'
                path1: '$(Pipeline.Workspace)/repository.chrisism/addons.xml'
                remote2: 'Local'
                path2: '$(Pipeline.Workspace)/repository.chrisism/plugin.program.akl/addon.xml'
                conflictVictor: 'file2'
                remoteTarget: 'file1'

            - script: md5sum addons.xml > addons.xml.md5
              workingDirectory: $(Pipeline.Workspace)/repository.chrisism/
              displayName: 'Creating md5 file for addons.xml'

            - script: |
                git add .
                git commit -m "Release $(Build.BuildNumber)"
              workingDirectory: $(Pipeline.Workspace)/repository.chrisism/script.module.akl
              displayName: 'Git - Add and commit'    

            - script: |
                git push https://$(github_token)@github.com/chrisism/repository.chrisism.git master 
              workingDirectory: $(Pipeline.Workspace)/repository.chrisism/script.module.akl
              displayName: 'Git - Push'    
